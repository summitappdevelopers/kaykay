(function(e){function r(e,t,n,r,i){jQuery.Event.call(this,e);this.collider=t;this.obstacle=n;this.collisionType=r;this.collision=i}function i(e,t,n,r){jQuery.Event.call(this,e);this.collider=t;this.obstacle=n;this.collisionType=r}function s(e,t,n,r){this.x1=e;this.y1=t;this.x2=n;this.y2=r}function o(e){if(e.length<=0)return null;var t=0;var n=0;var r=0;for(var i=0;i<e.length;i++){r+=e[i].area();t+=e[i].centerx()*e[i].area();n+=e[i].centery()*e[i].area()}var o=Math.sqrt(r);return new s(t/r-o/2,n/r-o/2,t/r+o/2,n/r+o/2)}function u(e,t,n){if(!t)t=0;if(!n)n=0;if(e.parent().length>0){var r=t+e.offset().left-(parseInt(e.css("margin-left"))||0);var i=n+e.offset().top-(parseInt(e.css("margin-top"))||0);var o=r+e.outerWidth(true);var u=i+e.outerHeight(true)}else{var r=t+parseInt(e.css("left"))||0;var i=n+parseInt(e.css("top"))||0;var o=r+parseInt(e.css("width"))||0;var u=i+parseInt(e.css("height"))||0;o+=(parseInt(e.css("margin-left"))||0)+(parseInt(e.css("border-left"))||0)+(parseInt(e.css("padding-left"))||0)+(parseInt(e.css("padding-right"))||0)+(parseInt(e.css("border-right"))||0)+(parseInt(e.css("margin-right"))||0);u+=(parseInt(e.css("margin-top"))||0)+(parseInt(e.css("border-top"))||0)+(parseInt(e.css("padding-top"))||0)+(parseInt(e.css("padding-bottom"))||0)+(parseInt(e.css("border-bottom"))||0)+(parseInt(e.css("margin-bottom"))||0)}return new s(r,i,o,u)}function a(t,n,r){return o(t.toArray().map(function(t,i,s){return u(e(t),n,r)}))}function f(t,n,r,i,s,o,f,l,c,h){if(!l)l=a(e(this.collider),s,o);if(!s)s=0;if(!o)o=0;this.collision=e(t);this.collider=e(t.data(n));this.obstacle=e(t.data(r));this.direction=t.data(f);this.type=i;this.dx=s;this.dy=o;this.centerOfMass=l;this.collisionCoords=u(this.collision);this.colliderCoords=u(this.collider,s,o);this.obstacleCoords=u(this.obstacle);if(!c)c=this.colliderCoords.centerx();if(!h)c=this.colliderCoords.centery();this.mousex=c;this.mousey=h}function l(e,t){var n=e.distance();var r=t.distance();return n<r?-1:n>r?+1:0}function c(t,n){this.draggable=e(t);this.obstacleSelector=n.obstacle||".ui-draggable-collision-obstacle";this.restraintSelector=n.restraint||".ui-draggable-collision-restraint";this.obstacle=e(n.obstacle||".ui-draggable-collision-obstacle");this.restraint=e(n.restraint||".ui-draggable-collision-restraint");var r=n.collider||".ui-draggable-dragging";this.collider=t.find(r).andSelf().filter(r);this.colliderData=n.colliderData||null;this.obstacleData=n.obstacleData||null;this.directionData=n.directionData||null;this.relative=n.relative||"body";this.preventCollision=n.preventCollision||false;this.preventProtrusion=n.preventProtrusion||false;this.collisions=e();this.protrusions=e()}function h(t,n,r,i,s){e.ui.plugin.call(n,r,i,s);t.trigger(i,s)}function p(t,n,r){var i=e(this).draggable("option")}function d(t,r){n=e(this).draggable("option").collisionVisualDebug;e(this).data("jquery-ui-draggable-collision-recent-position",r.originalPosition)}function v(r,i){e(this).removeData("jquery-ui-draggable-collision-cent-position");if(n)e(".testdebug").remove();n=t}function m(s,o){var l=e(this).data("jquery-ui-draggable-collision-recent-position");if(t){console.log("handleCollision ******************************************************************")}if(n)e(".testdebug").remove();var p="collision";var d="precollision";var v="postcollision";var m="protrusion";var y="preprotrusion";var b="postprotrusion";var w=e(this).data("ui-draggable");var E=e(this).draggable("option");var S=[];if(E.obstacle||E.restraint)S.push(new c(e(this),E));if(E.multipleCollisionInteractions&&E.multipleCollisionInteractions["length"]){var x=E.multipleCollisionInteractions;for(var T=0;T<x.length;T++)S.push(new c(e(this),x[T]))}if(S.length<=0){e(this).data("jquery-ui-draggable-collision-recent-position",o.position);return}var N="ui-draggable-collision-collider-temp";var C="ui-draggable-collision-obstacle-temp";var k="ui-draggable-collision-direction-temp";var L="ui-draggable-collision-interaction-temp";var A=s.data;var O="<div />";if(A&&A.as)O=A.as;var M;var _=1;for(var T=0;T<S.length;T++){_+=2*S[T].collider.length*(S[T].obstacle.length+S[T].restraint.length);if(n){S[T].obstacle.each(function(){e(this).clone().removeClass().empty().addClass("testdebug").css("pointer-events","none").css("background","transparent").css("padding","0px").css("border","1px solid black").css("margin","-1px").appendTo(e(this).parent())});S[T].restraint.each(function(){e(this).clone().removeClass().empty().addClass("testdebug").css("pointer-events","none").css("background","transparent").css("padding","0px").css("border","1px solid magenta").css("margin","-1px").appendTo(e(this).parent())})}if(S[T].obstacleSelector){M=new i(d,e(this),S[T].obstacle,p);h(S[T].collider,w,d,M,o)}if(S[T].restraintSelector){M=new i(y,e(this),S[T].restraint,m);h(S[T].collider,w,y,M,o)}}var D=l.left;var P=l.top;var H=o.position.left-l.left;var B=o.position.top-l.top;var j;var F;var I=[];var q=[];var R=[];var U=[];var z=e();if(w.containment){_+=2;var W=w.containment;z=e("<div />").offset({left:W[0],top:W[1]}).width(W[2]-W[0]+e(this).width()).height(W[3]-W[1]+e(this).height());if(n)z.clone().css("background","transparent").css("border","1px solid blue").css("margin","-1px").css("padding","0px").addClass("testdebug").appendTo()}var X={};var V=0;while(V<_){V++;j=o.position.left-l.left;F=o.position.top-l.top;I=[];q=[];R=[];for(var T=0;T<S.length;T++){S[T].collisions=e();S[T].protrusions=e();var J=S[T].collider;var K=S[T].obstacle;var Q=S[T].restraint;if(t)console.log("trying inter,c,o,r=",S[T],J,K,Q);J.each(function(){e(this).data("jquery-collision-coordinates",u(e(this),j,F))});var G=a(J);for(var Y=0;Y<J.length;Y++){var Z=e(J[Y]).collision(K,{mode:"collision",as:"<div />",colliderData:N,obstacleData:C,directionData:k,relative:"body"});if(t){console.log("collisions",Z)}Z.data(L,S[T]);S[T].collisions=S[T].collisions.add(Z);if(Z.length>0){q=Z.toArray().map(function(t,n,r){return new f(e(t),N,C,"collision",j,F,k,G,s.pageX,s.pageY)});I=I.concat(q);if(n)e("<span>c"+V+"</span>").appendTo(Z.addClass("testdebug").css("position","absolute").css("padding","0px").css("border","1px solid black").css("margin","-1").appendTo("body"))}Z=e(J[Y]).collision(Q,{mode:"protrusion",as:"<div />",colliderData:N,obstacleData:C,directionData:k,relative:"body"});if(t){console.log("protrusions",Z)}Z.data(L,S[T]);S[T].protrusions=S[T].protrusions.add(Z);if(Z.length>0){R=Z.toArray().map(function(t,n,r){return new f(e(t),N,C,"protrusion",j,F,k,G,s.pageX,s.pageY)});I=I.concat(R);if(n)e("<span>p"+V+"</span>").appendTo(Z.addClass("testdebug").css("position","absolute").css("padding","0px").css("border","1px solid magenta").css("margin","-1").appendTo("body"))}}J.each(function(){e(this).removeData("jquery-collision-coordinates")})}if(w.containment){e(this).each(function(){e(this).data("jquery-collision-coordinates",u(e(this),j,F))});var et=e(this).collision(z,{mode:"protrusion",as:"<div />",colliderData:N,obstacleData:C,directionData:k,relative:"body"});U=et.toArray().map(function(t,n,r){return new f(e(t),N,C,"protrusion",j,F,k,a(J),s.pageX,s.pageY)});if(n)e("<span>x"+V+"</span>").appendTo(et.addClass("testdebug").css("position","absolute").css("padding","0px").css("border","1px solid blue").css("margin","-1").appendTo("body"));e(this).each(function(){e(this).removeData("jquery-collision-coordinates")})}if(t)console.log("checking if we have any collisions at all...");if(q.length<=0&&R.length<=0&&U.length<=0)break;var tt=true;for(var T=0;T<S.length;T++){if(t)console.log("checking adjustments for",S[T],"ccl=",U,"pc,cl,pp,pl=",S[T].preventCollision,S[T].collisions.length,S[T].preventProtrusion,S[T].protrusions.length);if(t)console.log("checking if we overstepped our containment...");if(!S[T].preventCollision&&!S[T].preventProtrusion&&U.length>0){if(t){console.log("not trying to prevent anything, but jumped our containment",S[T])}tt=false}if(t)console.log("checking if we want to block something we have collided with...");if(S[T].preventCollision&&(S[T].collisions.length>0||U.length>0)||S[T].preventProtrusion&&(S[T].protrusions.length>0||U.length>0)){if(t){console.log("trying to prevent something that we're still hitting",S[T])}tt=false}}if(tt){if(t){console.log("done adjusting")}break}if(t)console.log("calculating delta with ocl,ccl=",I,U);var A=g(I.concat(),U,X);if(t)console.log("dx=",A.dx,"dy=",A.dy);if(A.dx==0&&A.dy==0)break;o.position.left+=A.dx;o.position.top+=A.dy}j=o.position.left-l.left;F=o.position.top-l.top;if(V>_||U.length>0||E.preventProtrusion&&R.length>0||E.preventCollision&&q.length>0){if(t)console.log("reverting, i=",V,"maxiter=",_,"cocl=",q,"cocl.len=",q.length,"pocl=",R,"pocl.len=",R.length,"ccl=",U,"ccl.len=",U.length,"origdx=",H,"origdy=",B,"dx=",j,"dy=",F);o.position.left=D;o.position.top=P}for(var Y=0;Y<I.length;Y++){var Z=I[Y];for(var nt=0;nt<Z.collision.length;nt++){var rt=e(Z.collision[nt]);var it=e(rt.data(N));var st=e(rt.data(C));var ot=rt.data(k);var ut=rt.data(L);rt.removeData(N).removeData(C).removeData(k).removeData(L);if(ut.colliderData)rt.data(ut.colliderData,it);if(ut.obstacleData)rt.data(ut.obstacleData,st);if(ot&&ut.directionData)rt.data(ut.directionData,ot);if(ut.relative&&ut.relative!="body"){var at=rt.offset();var ft=ut.relative=="collider"?it:ut.relative=="obstacle"?st:e(ut.relative);var lt=ft.offset();rt.offset({left:at.left-lt.left,top:at.top-lt.top})}if(ut.obstacleSelector&&Z.type=="collision"){M=new r(p,it,st,p,rt);h(it,w,p,M,o)}if(ut.restraintSelector&&Z.type=="protrusion"){M=new r(m,it,st,m,rt);h(it,w,m,M,o)}}}for(var T=0;T<S.length;T++){if(S[T].obstacleSelector){M=new i(v,e(this),S[T].obstacle,p);h(S[T].collider,w,v,M,o)}if(S[T].restraintSelector){M=new i(b,e(this),S[T].restraint,m);h(S[T].collider,w,b,M,o)}}e(this).data("jquery-ui-draggable-collision-recent-position",o.position)}function g(r,i,s){var o=r.concat(i).sort(l);if(n){if(!s.deltanum){s.deltanum=1}}if(t){console.log("collisions, in order: ",o.map(function(e,t,n){return e.collisionCoords.hash()}).join(","))}while(o.length>0){var u=o.pop();var a=u.obstacleCoords;var f=u.colliderCoords;var c=u.collisionCoords;var h=u.type;var p=u.direction;var d=u.hash();var v=u.type=="protrusion"?f.centerx()>a.centerx()?-1:+1:f.centerx()>a.centerx()?+1:-1;var m=u.type=="protrusion"?f.centery()>a.centery()?-1:+1:f.centery()>a.centery()?+1:-1;var g=u.embedx(v);var y=u.embedy(m);if(t)console.log("cv,cc,co,ct,dx,dy,thisc.dx,thisc.dy,dirx,diry,co.centerx,co.centery,cc.centerx,cc.centery,key=",c.hash(),f.hash(),a.hash(),h,g,y,u.dx,u.dy,v,m,a.centerx(),a.centery(),f.centerx(),f.centery(),d);var b=g<y;if(d in s&&s[d]=="tried reverse"){if(t)console.log("but already tried reverse too...");continue}else if(d in s&&s[d]=="tried normal"){if(t)console.log("but already tried this...");b=!b;s[d]="tried reverse"}else{s[d]="tried normal"}if(b){if(n){e("<span>"+u.direction+"d"+s.deltanum+".dx="+g+"*"+v+"</span>").css("color","black").addClass("testdebug").css("position","absolute").css("white-space","nowrap").offset({left:u.mousex,top:u.mousey+20*(s.deltanum-1)}).appendTo("body");s.deltanum++}if(g<=0){o.push(u);continue}return{dx:g*v,dy:0}}else{if(n){e("<span>"+u.direction+"d"+s.deltanum+".dy="+y+"*"+m+"</span>").css("color","black").addClass("testdebug").css("position","absolute").css("white-space","nowrap").offset({left:u.mousex,top:u.mousey+20*(s.deltanum-1)}).appendTo("body");s.deltanum++}if(y<=0){o.push(u);continue}return{dx:0,dy:y*m}}}return{dx:0,dy:0}}var t=false;var n=t;e.ui.draggable.prototype.options.obstacle=".ui-draggable-collision-obstacle";e.ui.draggable.prototype.options.restraint=".ui-draggable-collision-restraint";e.ui.draggable.prototype.options.collider=".ui-draggable-dragging";e.ui.draggable.prototype.options.colliderData=null;e.ui.draggable.prototype.options.obstacleData=null;e.ui.draggable.prototype.options.directionData=null;e.ui.draggable.prototype.options.relative="body";e.ui.draggable.prototype.options.preventCollision=false;e.ui.draggable.prototype.options.preventProtrusion=false;e.ui.draggable.prototype.options.collisionVisualDebug=false;e.ui.draggable.prototype.options.multipleCollisionInteractions=[];e.ui.plugin.add("draggable","obstacle",{create:function(e,t){p.call(this,e,t)},start:function(e,t){d.call(this,e,t)},drag:function(e,t){return m.call(this,e,t)},stop:function(e,t){m.call(this,e,t);v.call(this,e,t)}});e.ui.plugin.add("draggable","restraint",{create:function(e,t){p.call(this,e,t)},start:function(t,n){if(!e(this).draggable("option","obstacle")){d.call(this,t,n)}},drag:function(t,n){if(!e(this).draggable("option","obstacle")){return m.call(this,t,n)}},stop:function(t,n){if(!e(this).draggable("option").obstacle){m.call(this,t,n);v.call(this,t,n)}}});e.ui.plugin.add("draggable","multipleCollisionInteractions",{create:function(e,t){p.call(this,e,t)},start:function(t,n){if(!e(this).draggable("option").obstacle&&!e(this).draggable("option").restraint){d.call(this,t,n)}},drag:function(t,n){if(!e(this).draggable("option").obstacle&&!e(this).draggable("option").restraint){return m.call(this,t,n)}},stop:function(t,n){if(!e(this).draggable("option").obstacle&&!e(this).draggable("option").restraint){m.call(this,t,n);v.call(this,t,n)}}});r.prototype=new e.Event("");i.prototype=new e.Event("");s.prototype.width=function(){return this.x2-this.x1};s.prototype.height=function(){return this.y2+this.y1};s.prototype.centerx=function(){return(this.x1+this.x2)/2};s.prototype.centery=function(){return(this.y1+this.y2)/2};s.prototype.area=function(){return this.width()*this.height()};s.prototype.hash=function(){return"["+[this.x1,this.y1,this.x2,this.y2].join(",")+"]"};s.prototype.distance=function(e){return this.distanceTo(e.centerx(),e.centery())};s.prototype.distanceTo=function(e,t){var n=this.centerx()-e;var r=this.centerx()-t;return Math.sqrt(n*n+r*r)};f.prototype.embedx=function(e){if(this.type=="collision"){if(e<0)return this.colliderCoords.x2-this.obstacleCoords.x1;if(e>0)return this.obstacleCoords.x2-this.colliderCoords.x1}else if(this.type=="protrusion"){if(this.direction=="N"||this.direction=="S")return 0;if(e<0)return this.colliderCoords.x2-this.obstacleCoords.x2;if(e>0)return this.obstacleCoords.x1-this.colliderCoords.x1}return 0};f.prototype.embedy=function(e){if(this.type=="collision"){if(e<0)return this.colliderCoords.y2-this.obstacleCoords.y1;if(e>0)return this.obstacleCoords.y2-this.colliderCoords.y1}else if(this.type=="protrusion"){if(this.direction=="E"||this.direction=="W")return 0;if(e<0)return this.colliderCoords.y2-this.obstacleCoords.y2;if(e>0)return this.obstacleCoords.y1-this.colliderCoords.y1}return 0};f.prototype.distance=function(){var e=this.centerOfMass.centerx();var t=this.centerOfMass.centery();var n=this.collisionCoords.centerx();var r=this.collisionCoords.centery();return Math.sqrt((n-e)*(n-e)+(r-t)*(r-t))};f.prototype.hash=function(){return this.type+"["+this.colliderCoords.hash()+","+this.obstacleCoords.hash()+"]"};})(jQuery)